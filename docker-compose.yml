services:

    # --- INFRAESTRUCTURA ---

    registry-server:
        build: ./registry
        container_name: registry-server
        restart: always
        ports:
            - "8761:8761"
        networks:
            - microservices-net
        healthcheck:
            test: ["CMD", "wget", "-q", "-O", "-", "http://registry-server:8761/actuator/health"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        logging:
            driver: json-file
            options:
                max-size: "5m"

    config-server:
        build: ./config
        container_name: config-server
        restart: always
        ports:
            - "7777:7777"
        environment:
            EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-server:8761/eureka/
            SPRING_PROFILES_ACTIVE: docker,dev,native
        networks:
            - microservices-net
        healthcheck:
            test: ["CMD", "wget", "-q", "-O", "-", "http://config-server:7777/actuator/health"]
            interval: 10s
            timeout: 5s
            retries: 10
            start_period: 30s
        depends_on:
            registry-server:
                condition: service_healthy
        logging:
            driver: json-file
            options:
                max-size: "5m"

    gateway:
        build:
            context: .
            dockerfile: gateway/Dockerfile
        container_name: gateway
        restart: always
        ports:
            - "4040:4040"
        environment:
            SPRING_PROFILES_ACTIVE: docker
            EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-server:8761/eureka/
        networks:
            - microservices-net
        depends_on:
            registry-server:
                condition: service_healthy
            config-server:
                condition: service_healthy
            users-server:
                condition: service_started
            catalog-server:
                condition: service_started
            posts-server:
                condition: service_started
            page-profiles-server:
                condition: service_started
            images-server:
                condition: service_started
            events-server:
                condition: service_started
            results-server:
                condition: service_started
            notification-server:
                condition: service_started
        logging:
            driver: json-file
            options:
                max-size: "5m"

    # --- MICROSERVICIOS DE NEGOCIO ---

    users-server:
        build:
            context: .
            dockerfile: users/Dockerfile
        container_name: users-server
        restart: always
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SERVER_PORT: 8081
            EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-server:8761/eureka/
            SPRING_CONFIG_IMPORT: "configserver:http://config-server:7777"
        networks:
            - microservices-net
        depends_on:
            config-server:
                condition: service_healthy
            registry-server:
                condition: service_healthy
            users-db:
                condition: service_started
        logging:
            driver: json-file
            options:
                max-size: "5m"

    catalog-server:
        build:
            context: .
            dockerfile: catalog/Dockerfile
        container_name: catalog-server
        restart: always
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SERVER_PORT: 8082
            EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-server:8761/eureka/
            SPRING_CONFIG_IMPORT: "configserver:http://config-server:7777"
        networks:
            - microservices-net
        depends_on:
            config-server:
                condition: service_healthy
            registry-server:
                condition: service_healthy
            catalog-db:
                condition: service_started
        logging:
            driver: json-file
            options:
                max-size: "5m"

    posts-server:
        build:
            context: .
            dockerfile: posts/Dockerfile
        container_name: posts-server
        restart: always
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SERVER_PORT: 8083
            EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-server:8761/eureka/
            SPRING_CONFIG_IMPORT: "configserver:http://config-server:7777"
        networks:
            - microservices-net
        depends_on:
            config-server:
                condition: service_healthy
            registry-server:
                condition: service_healthy
            posts-db:
                condition: service_started
        logging:
            driver: json-file
            options:
                max-size: "5m"

    page-profiles-server:
        build:
            context: .
            dockerfile: page-profiles/Dockerfile
        container_name: page-profiles-server
        restart: always
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SERVER_PORT: 8084
            EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-server:8761/eureka/
            SPRING_CONFIG_IMPORT: "configserver:http://config-server:7777"
        networks:
            - microservices-net
        depends_on:
            config-server:
                condition: service_healthy
            registry-server:
                condition: service_healthy
            page-profiles-db:
                condition: service_started
        logging:
            driver: json-file
            options:
                max-size: "5m"

    images-server:
        build:
            context: .
            dockerfile: images/Dockerfile
        container_name: images-server
        restart: always
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SERVER_PORT: 8085
            EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-server:8761/eureka/
            SPRING_CONFIG_IMPORT: "configserver:http://config-server:7777"
        volumes:
            - ./images_data:/app/images
        networks:
            - microservices-net
        depends_on:
            config-server:
                condition: service_healthy
            registry-server:
                condition: service_healthy
        logging:
            driver: json-file
            options:
                max-size: "5m"

    events-server:
        build:
            context: .
            dockerfile: events/Dockerfile
        container_name: events-server
        restart: always
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SERVER_PORT: 8086
            EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-server:8761/eureka/
            SPRING_CONFIG_IMPORT: "configserver:http://config-server:7777"
        networks:
            - microservices-net
        depends_on:
            config-server:
                condition: service_healthy
            registry-server:
                condition: service_healthy
            events-db:
                condition: service_started
        logging:
            driver: json-file
            options:
                max-size: "5m"

    results-server:
        build:
            context: .
            dockerfile: results/Dockerfile
        container_name: results-server
        restart: always
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SERVER_PORT: 8087
            EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-server:8761/eureka/
            SPRING_CONFIG_IMPORT: "configserver:http://config-server:7777"
        networks:
            - microservices-net
        depends_on:
            config-server:
                condition: service_healthy
            registry-server:
                condition: service_healthy
        logging:
            driver: json-file
            options:
                max-size: "5m"

    notification-server:
        build:
            context: .
            dockerfile: notifications/Dockerfile
        container_name: notification-server
        restart: always
        environment:
            SPRING_PROFILES_ACTIVE: docker
            SERVER_PORT: 8088
            EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://registry-server:8761/eureka/
            SPRING_CONFIG_IMPORT: "configserver:http://config-server:7777"
        networks:
            - microservices-net
        depends_on:
            config-server:
                condition: service_healthy
            registry-server:
                condition: service_healthy
            notifications-db:
                condition: service_started
        logging:
            driver: json-file
            options:
                max-size: "5m"

    # --- BASES DE DATOS ---

    catalog-db:
        image: postgres:15.3
        restart: always
        environment:
            POSTGRES_DB: catalog-db
            POSTGRES_USER: develop
            POSTGRES_PASSWORD: develop
            POSTGRES_HOST_AUTH_METHOD: trust
        volumes:
            - ./dabatase/catalog-db:/var/lib/postgresql/data
        ports:
            - 5433:5432
        networks:
            - microservices-net
        logging:
            driver: json-file
            options:
                max-size: "5m"

    events-db:
        image: postgres:15.3
        restart: always
        environment:
            POSTGRES_DB: events-db
            POSTGRES_USER: develop
            POSTGRES_PASSWORD: develop
            POSTGRES_HOST_AUTH_METHOD: trust
        volumes:
            - ./dabatase/events-db:/var/lib/postgresql/data
        ports:
            - 5437:5432
        networks:
            - microservices-net
        logging:
            driver: json-file
            options:
                max-size: "5m"

    page-profiles-db:
        image: postgres:15.3
        restart: always
        environment:
            POSTGRES_DB: page-profiles-db
            POSTGRES_USER: develop
            POSTGRES_PASSWORD: develop
            POSTGRES_HOST_AUTH_METHOD: trust
        volumes:
            - ./dabatase/page-profiles-db:/var/lib/postgresql/data
        ports:
            - 5436:5432
        networks:
            - microservices-net
        logging:
            driver: json-file
            options:
                max-size: "5m"

    posts-db:
        image: postgres:15.3
        restart: always
        environment:
            POSTGRES_DB: posts-db
            POSTGRES_USER: develop
            POSTGRES_PASSWORD: develop
            POSTGRES_HOST_AUTH_METHOD: trust
        volumes:
            - ./dabatase/posts-db:/var/lib/postgresql/data
        ports:
            - 5435:5432
        networks:
            - microservices-net
        logging:
            driver: json-file
            options:
                max-size: "5m"

    users-db:
        image: postgres:15.3
        restart: always
        environment:
            POSTGRES_DB: users-db
            POSTGRES_USER: develop
            POSTGRES_PASSWORD: develop
            POSTGRES_HOST_AUTH_METHOD: trust
        volumes:
            - ./dabatase/users-db:/var/lib/postgresql/data
        ports:
            - 5432:5432
        networks:
            - microservices-net
        logging:
            driver: json-file
            options:
                max-size: "5m"

    notifications-db:
        image: postgres:15.3
        restart: always
        environment:
            POSTGRES_DB: notifications-db
            POSTGRES_USER: develop
            POSTGRES_PASSWORD: develop
            POSTGRES_HOST_AUTH_METHOD: trust
        volumes:
            - ./dabatase/notifications-db:/var/lib/postgresql/data
        ports:
            - 5438:5432
        networks:
            - microservices-net
        logging:
            driver: json-file
            options:
                max-size: "5m"

networks:
    microservices-net:
        driver: bridge
